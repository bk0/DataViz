<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Visualization Project</title>



    <style type="text/css">

      body {
        font: 12px sans-serif;
      }

      .axis path, .axis line,
      .axis_l path, .axis_l line,
      .axis_m path, .axis_m line,
      .axis_h path, .axis_h line {
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
      }

    </style>




		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

	</head>








	<body>
    <div style="float: left; position: relative; left: 20%"> Gender <select id="select_gender"></select>
    </div>

    <div id="container" style="width: 1170px;margin: auto;">

<!-- <div id="ckbx_sort" style="width: 10%; float: left;"><label><input type="checkbox"> Sort </label></div> -->


      <div id="plots" style:"style=width: 700px;float: left;">
        <div id="line_chart" style="width: 700px;float: left;">
        <div id="horz_bar" style="width: 700px; float: left;">
        </div>
      </div></div>

      <div id="sm_mult" style="width: 460px; float: left;"></div>

    </div>



<br><br>

<div style="float: left;">

<h2>Techniques</h2>

<ol>
  <li><u>Horizontal Bar Plot</u>: I chose a horizontal bar plot to show the per capita rate of the various methods of suicide mainly because the descriptors for the methods of suicide are too long&nbsp;for a vertical bar plot. &nbsp;I chose to include the per capita rates at the end of the bars because some of the rates are very low. &nbsp;I did not want to round the number less than for decimal places because then some of the categories would be rounded to zero. &nbsp;The lie factor is low because the plot starts with zero and contains the actual numbers. &nbsp;The data density and data-ink ratio are&nbsp;middle-of-the-road. &nbsp;</li>
  <li><u>Line Plot</u>: &nbsp;I chose a line plot to show the per capita suicide rate over time from 1999 through 2013. &nbsp;As expected it shows trends in the suicide rate. &nbsp;The lie factor is low because the plot starts with zero. &nbsp;Due to nature of a simple line plot, the data density and data-ink ratio are on the low side because the overall plot is large, but there is only one line on it and it has a bunch of empty space. &nbsp;</li>
  <li><u>Small Multiples</u>: &nbsp;With the small multiples, I wanted to show how the suicide rate differs for different age groups and different races. &nbsp;Each small multiple represents a different race and within each multiple, the bars represent the age groups. &nbsp;The lie factor is low to moderate because each multiple is scaled to the max of each race; therefore, one could mistaken the per capita rates to be similar if the y-axis is overlooked.</li>
</ol>

<p style="margin-left: 40px;"><u>General Notes</u>:</p>

<ul>
  <li style="margin-left: 40px;">I used one csv for all three visualizations by loading it once, but filtering it for each visualization and each interaction from the user.</li>
  <li style="margin-left: 40px;">I encoded the bars and line by gender so there are three different colors (Male, Female, and Both).</li>
  <li style="margin-left: 40px;">I chose each visualization because they show a pattern or trend. &nbsp;The horizontal bar plot shows the difference between the sexes and races with respect to method of suicide. &nbsp;The line plot shows how the race and gender differ in their historical trend for suicide. &nbsp;The small multiples shows how differenet races have different patterns of suicide depending on age.</li>
  <li style="margin-left: 40px;">All plots were done in pure D3.</li>
  <li style="margin-left: 40px;">This is part of lie factor: &nbsp;Since white males commit suicide so much more than any other group, they have the highest influence on any per capita rate that includes them.</li>
</ul>

<p style="margin-left: 40px;">&nbsp;</p>

<h2>Interactivity</h2>

<p style="margin-left: 40px;">&nbsp;</p>

<p style="margin-left: 40px;">If the user clicks on the years on the bottom of the line plot, the selected year is highlighed in red&nbsp;and will change the other two plots for that year selection. &nbsp;Clicking again on the same year will remove the filter by year and all years will be displayed in the other two plots. &nbsp;If the user clicks on a small multiple representing a specific race, then the data in the other two plots will be changed to reflect that race only. &nbsp;The active race selection is indicated by the red label of the race in the corner of each small multiple plot. &nbsp;Clicking the &quot;All Races&quot; small multiple will bring the user back to the default. &nbsp; Using the dropdown menu, the user can select gender and all the plots will update. &nbsp; All interactions help the user find or explore the data.</p>

<p style="margin-left: 40px;">&nbsp;</p>

<h2>Feedback</h2>

<p style="margin-left: 40px;">I love the dual y-axis plot for showing similar trends, but my group feedback on this was not good so I deleted it and went with a simple line plot as recommended.&nbsp; They believed that the viewer could be confused by the differing scales and attribute the lines improperly. &nbsp;I agreed with this assessment.</p>

<p style="margin-left: 40px;">&nbsp;</p>

<h2>Challenges</h2>

<p style="margin-left: 40px;">I spent hours looking online and testing different ways to construct a dropdown menu this was by far the most frustrating this I encountered.&nbsp;I just assumed that the dropdown menu would work since it looked very simple, but I have been humbled. &nbsp;Aside from this, my initial challenge was data preprocessing since it took a long time. &nbsp;I had to run 35 reports from the CDC website and paste them together.&nbsp;&nbsp;I was also&nbsp;hard to plan how my data should be formed before actually coding, so I had to go back manipulate my data as I went to fit my needs when I first started. &nbsp;I started a US map visualization, but it wasn&#39;t linked to the other visualization with interactions&nbsp;(because of the limitation by the CDC on using certain data below a national level)&nbsp;and it would make my total visualization roll beyond one screen, so I decided not to finish it. &nbsp;I was planning to shade each state with various statistics as picked in a dropdown menu, but I ran into trouble making a dropdown menu work on the map too.</p>

<p style="margin-left: 40px;">&nbsp;</p>

<h2>Conclusion</h2>

<ul>
  <li style="margin-left: 40px;">From the horizontal bar chart, I can see that females prefer more gentle methods of suicide (e.g., self-poisoning, hanging) compared to males who overwhelmingly prefer to use a firearm with the exception of Asian males.  Asian females used Hanging, Strangulation and Suffocation to commit suicide much more than any other method.  Around 1999 and 2000, females used firearms to commit suicide more than they did in more recent years.  Males also followed this trend where they used firearms slightly more than earlier years.</li>
  <li style="margin-left: 40px;">From the line chart, I see that the suicide rate is trending up, but flat&nbsp;for some groups like black males.</li>
  <li style="margin-left: 40px;">From small multiples, I see that the per capital suicide rate for males goes up usually in the 85+ age group for all races except American Indian/Alaska Native. &nbsp;For males, the suicide rate for Asians and Whites increases with ages while American Indian/Alaska Natives and Blacks usually peak in their twenties or thirties.  For females, the suicde rate is slightly higher in mid-life, but does not exhibit the large increase in suicide rate in the 85+ age group that males exhibit.</li>
  <li style="margin-left: 40px;">Across all plots, females have a much lower suicide rate than males.</li>
</ul>
</div>






		<script type="text/javascript">



      var dataset;


      d3.csv("Data03.csv", function(data){


        var filters_gen = {
                            year: 'All',
                            gender: 'Both',
                            race: 'All Races',
                            age_group: 'All',
                            death_cause: 'All'
                          };

        var race_prev, race_curr, year_prev, year_curr, gender_prev, gender_curr;

        race_prev = deepcopy(filters_gen.race);
        year_prev = deepcopy(filters_gen.year);
        gender_prev = deepcopy(filters_gen.gender);

        race_curr = deepcopy(race_prev);
        year_curr = deepcopy(year_prev);
        gender_curr = deepcopy(gender_prev);

        var filters_horz = deepcopy(filters_gen);

        filters_horz.death_cause = [
                                    'Blunt Object',
                                    'Crashing Of Motor Vehicle',
                                    'Drowning and Submersion',
                                    'Explosive Material',
                                    'Firearm',
                                    'Hanging, Strangulation and Suffocation',
                                    'Intentional Self-Poisoning',
                                    'Jumping From A High Place',
                                    'Jumping Or Lying Before Moving Object',
                                    'Other and Unspecified Means',
                                    'Sequelae of Intentional Self-Harm',
                                    'Sharp Object',
                                    'Smoke, Fire and Flames',
                                    'Steam, Hot Vapours and Hot Objects',
                                    'Terrorism: Explosions and Fragments',
                                    'Terrorism: Other and Unspecified means'
                                    ];



        var filters_mult = deepcopy(filters_gen);

        filters_mult.race = [
                            'All Races',
                            'American Indian or Alaska Native',
                            'Asian or Pacific Islander',
                            'Black or African American',
                            'White'
                            ]

        filters_mult.age_group = [
                                  '05-09',
                                  '10-14',
                                  '15-19',
                                  '20-24',
                                  '25-34',
                                  '35-44',
                                  '45-54',
                                  '55-64',
                                  '65-74',
                                  '75-84',
                                  '85+'
                                  ];


        var filters_line = deepcopy(filters_gen);

        filters_line.year = ['1999', '2000', '2001', '2002', '2003', '2004', '2005', '2006', 
                              '2007', '2008', '2009', '2010', '2011', '2012', '2013']



        var rnd_digits = d3.format("0.4f")




        dataset = data;


        //decode the data.  I did this to make the csv file smaller and load quicker.
        for (var key in dataset){
          switch (dataset[key].race) {
            case 'A':
              dataset[key].race = 'All Races';
              break;
            case 'B':
              dataset[key].race = 'American Indian or Alaska Native';
              break;
            case 'C':
              dataset[key].race = 'Asian or Pacific Islander';
              break;
            case 'D':
              dataset[key].race = 'Black or African American';
              break;
            case 'E':
              dataset[key].race = 'White';
              break;
          }

          switch (dataset[key].death_cause) {
            case 'A':
              dataset[key].death_cause = 'All';
              break;
            case 'B':
              dataset[key].death_cause = 'Blunt Object';
              break;
            case 'C':
              dataset[key].death_cause = 'Crashing Of Motor Vehicle';
              break;
            case 'D':
              dataset[key].death_cause = 'Drowning and Submersion';
              break;
            case 'E':
              dataset[key].death_cause = 'Explosive Material';
              break;
            case 'F':
              dataset[key].death_cause = 'Firearm';
              break;
            case 'G':
              dataset[key].death_cause = 'Hanging, Strangulation and Suffocation';
              break;
            case 'H':
              dataset[key].death_cause = 'Intentional Self-Poisoning';
              break;
            case 'I':
              dataset[key].death_cause = 'Jumping From A High Place';
              break;
            case 'J':
              dataset[key].death_cause = 'Jumping Or Lying Before Moving Object';
              break;
            case 'K':
              dataset[key].death_cause = 'Other and Unspecified Means';
              break;
            case 'L':
              dataset[key].death_cause = 'Sequelae of Intentional Self-Harm';
              break;
            case 'M':
              dataset[key].death_cause = 'Sharp Object';
              break;
            case 'N':
              dataset[key].death_cause = 'Smoke, Fire and Flames';
              break;
            case 'O':
              dataset[key].death_cause = 'Steam, Hot Vapours and Hot Objects';
              break;
            case 'P':
              dataset[key].death_cause = 'Terrorism: Explosions and Fragments';
              break;
          }
        }


        //color scale for gender
        var c = d3.scale.ordinal()
                  .domain(d3.set(dataset.map(function(d) { return d.gender; })).values())
                  .range(["#969696", "#f7b6d2", "#aec7e8"]);



        var menu = d3.select("select#select_gender")
          .on("change",  function() {update_plots("gender", this.options[this.selectedIndex].__data__);})
          ;

        menu.selectAll("option")
          .data(d3.map(dataset, function(d){return d.gender;}).keys())
          .enter()
          .append("option")
          .text(function(d){return d;})
          .attr("value",function(d){return d;});

          //window.onload = d3.selectAll("select").on("change", update_plots("gender", d3.select("select").property("value")));




        function update_plots(element, newval) {
          console.log(element, newval);

          switch (element) {
            case "gender":
              gender_curr = deepcopy(newval);
              if (gender_curr != gender_prev){
                filters_horz.gender = deepcopy(gender_curr);
                filters_mult.gender = deepcopy(gender_curr);
                filters_line.gender = deepcopy(gender_curr);
                update_horz();
                update_mult();
                update_line();
                gender_prev = deepcopy(gender_curr);
              }
                break;
            case "race":
              race_curr = deepcopy(newval);
              if (race_curr != race_prev){
                filters_horz.race = deepcopy(race_curr);
                filters_line.race = deepcopy(race_curr);
                update_horz();
                update_line();
                update_mult_select();
                race_prev = deepcopy(race_curr);
              }
              break;
            case "year":
              if ( newval == year_prev){
                year_curr = 'All';
              }
              else{
                year_curr = deepcopy(newval);
              }

              filters_horz.year = deepcopy(year_curr);
              filters_mult.year = deepcopy(year_curr);

              update_horz();
              update_mult();
              update_year_select();

              year_prev = deepcopy(year_curr);
              break;
          }
        }





        function draw_line_chart() {

          var margin = {top: 20, right: 50, bottom: 50, left: 75},
              width = 700 - margin.left - margin.right,
              height = 331 - margin.top - margin.bottom;

          var data_line = subset(dataset, filters_line); 



          var svg_line = d3.select("#line_chart")
            .append("svg")
              .attr("id", "line_plot")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


          var x = d3.scale.linear()
            .domain(d3.extent(data_line, function(d) { return +d.year; }))
            .range([0, width])
            ;

          var x_bar = d3.scale.ordinal()
            .domain(data_line.map(function(d) { return d.year; }))
            .rangeRoundBands([-25, width+25], 0.1);

            
          var y = d3.scale.linear()
            .domain([0, d3.max(data_line, function(d) { return +d.capita; })]).nice()
            .range([height, 0])
            ;

          var xAxis = d3.svg.axis()
            .scale(x)
            .tickValues(filters_line.year)
            .tickFormat(d3.format("d"))
            .orient("bottom");


          var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left"); 
          
          var line = d3.svg.line()
            .x(function(d) { return x(+d.year); })
            .y(function(d) {  return y(+d.capita); })
            ;
          
          svg_line.selectAll(".bar")
            .data(data_line)
            .enter().append("rect")
            .attr("class", function(d) { return "Y"+d.year;})
            .attr("x", function(d) { return x_bar(d.year); })
            .attr("y", height + margin.top - 15)
            .attr("height", 15)
            .attr("width", x_bar.rangeBand())
            .style("fill", "red")
            .style("opacity", 0);

          svg_line.append("g")
            .attr("class", "y axis_l")
            .call(yAxis);

          svg_line.append("g")
            .attr("class", "x axis_l")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

          svg_line.append("text")
            .attr("class", "x label")
            .attr("text-anchor", "middle")
            .attr("x", width / 2)
            .attr("y", height + margin.top +10)
            .text("Year")
            ;

          svg_line.append("text")
            .attr("class", "y label")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - (margin.left/2 ))
            .attr("x", 0 - (height / 2))
            .attr("dy", ".75em")
            .style("text-anchor", "middle")
            .text("Per Capita Suicide Rate");

          svg_line.append("path")
            .datum(data_line)
            .attr("class", "lineplotpath")
            .attr("d", line)  
            .style("fill", "none")
            .style("stroke-width", 4)
            .attr("stroke", c(data_line[0].gender))
              ;


           svg_line.selectAll("text")
             .filter(function(d){ return +d >= 1999 })
             .on("click",  function(d) { update_plots("year", d);})
             ;

        }

        draw_line_chart();

        function update_year_select() {
          if (year_prev == 'All'){
            d3.select(".Y" + year_curr)
              .style("opacity", 0.9);
          }
          else{
            if (year_curr == 'All'){
              d3.select(".Y" + year_prev)
                .style("opacity", 0);
            }
            else{
              d3.select(".Y" + year_prev)
                .style("opacity", 0);

              d3.select(".Y" + year_curr)
                .style("opacity", 0.9);
            }
          }
        }


        function update_line() {

          var margin = {top: 20, right: 50, bottom: 50, left: 75},
              width = 700 - margin.left - margin.right,
              height = 331 - margin.top - margin.bottom;

          var data_line = subset(dataset, filters_line); 

          var x = d3.scale.linear()
            .domain(d3.extent(data_line, function(d) { return +d.year; }))
            .range([0, width])
            ;
            
          var y = d3.scale.linear()
            .domain([0, d3.max(data_line, function(d) { return +d.capita; })]).nice()
            .range([height, 0])
            ;

          var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left"); 

          var line = d3.svg.line()
            .x(function(d) { return x(+d.year); })
            .y(function(d) {  return y(+d.capita); })
            ;

          d3.select(".lineplotpath")
            .datum(data_line)
            .transition()
            .duration(750)
            .attr("d", line)  
            .attr("stroke", c(data_line[0].gender))
              ;

          d3.select("#line_chart").select(".y.axis_l")
            .transition()
            .duration(750)
            .call(yAxis);

        }




        function draw_sm_mult(){

          var margin = {top: 25, right: 10, bottom: 28, left: 30},
            width = 500 - margin.left - margin.right,
            height = 140 - margin.top - margin.bottom;


          var data_mult = subset(dataset, filters_mult).sort(function(a, b) {
            return d3.ascending(a.age_group, b.age_group); 
          }); 

          var nested_data_mult = d3.nest()
            .key(function(d) { return d.race; }).sortKeys(d3.ascending)
            .entries(data_mult);

          var y = d3.scale.linear()
            .range([height, 0]);

          var x = d3.scale.ordinal()
            .domain(data_mult.map(function(d) { return d.age_group; }))
            .rangeRoundBands([0, width], 0.1);



          var xAxis0 = d3.svg.axis()
            .scale(x)
            .tickFormat('')
            .innerTickSize(0)
            .outerTickSize(0)
            .orient("bottom");


          var xAxis1 = d3.svg.axis()
            .scale(x)
            .innerTickSize(0)
            .outerTickSize(0)
            //.tickPadding(2)
            .orient("bottom");


          var svg_mult = d3.select("#sm_mult").selectAll("svg")
              .data(nested_data_mult)
            .enter().append("svg")
              .on("click", function(d) { update_plots("race", d.key);})
              .attr("id", function(d) { return "plot_" + d.key.replace(/\s+/g, '');})
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
              .each(multiple);


          svg_mult.append("text")
            .attr("x", 0)
            .attr("y", -2)
            .attr("class", "mult_race_labels")
            .attr("id", function(d) { return "labels_" + d.key.replace(/\s+/g, '');})
            .style("text-anchor", "start")
            .style("font-weight", "bold")
            .style("font-style", "italic")
            .style("fill", function(d) { if (d.key == race_curr) { return "red"; } else { return "black"; }})
            .text(function(d) { return d.key; })
            ;


          function multiple(single) {

            var cur_svg = d3.select(this);

            var y_max = d3.max(single.values, function(d) { return +d.capita; })

            y.domain([0, y_max]).nice();

            var yAxis = d3.svg.axis()
              .scale(y)
              .orient("left")
              .ticks(5)
              .tickPadding(10)
              .innerTickSize(0)
              .tickValues([0, y_max])
              ;

            cur_svg.selectAll(".bar")
              .data(single.values)
              .enter().append("rect")
              .attr("class", "bar")
              .attr("x", function(d) { return x(d.age_group); })
              .attr("y", function(d) { return y(+d.capita); })
              .attr("height", function(d) { return height - y(+d.capita);})
              .attr("width", x.rangeBand())
              .style("fill",function(d) {return c(d.gender);})
              .style("opacity", 1);

            cur_svg.append("g")
              .attr("class", "y axis_m")
              .call(yAxis);


            cur_svg.append("text")
              .attr("class", "y label")
              .attr("transform", "rotate(-90)")
              .attr("y", 0 - (margin.left/2 ))
              .attr("x", 0 - (height / 2))
              .attr("dy", ".75em")
              .style("text-anchor", "middle")
              .text("Rate");


            if (single.key === "White") {
              cur_svg.append("g")
                .attr("class", "x axis_m")
                .attr("transform", "translate(0," + height  + ")")
                .call(xAxis1);

              cur_svg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.top - 2)
                .text("Age")
                ;

            }
            else{
              cur_svg.append("g")
                .attr("class", "x axis_m")
                .attr("transform", "translate(0," + height  + ")")
                .call(xAxis0);
            }
          }
        }


        draw_sm_mult();



        function update_mult_select() {
          d3.select("#labels_" + race_prev.replace(/\s+/g, ''))
            .transition()
            .style("fill", "black");

          d3.select("#labels_" + race_curr.replace(/\s+/g, ''))
            .transition()
            .style("fill", "red");
        }




        function update_mult() {

          var margin = {top: 25, right: 10, bottom: 28, left: 30},
            width = 500 - margin.left - margin.right,
            height = 140 - margin.top - margin.bottom;


          var data_mult = subset(dataset, filters_mult).sort(function(a, b) {
            return d3.ascending(a.age_group, b.age_group); 
          }); 

          var nested_data_mult = d3.nest()
            .key(function(d) { return d.race; }).sortKeys(d3.ascending)
            .entries(data_mult);


          var x = d3.scale.ordinal()
            .domain(data_mult.map(function(d) { return d.age_group; }))
            .rangeRoundBands([0, width], 0.1);

          var y, y_max, yAxis;

          for (var i = 0; i < nested_data_mult.length; i++) {

            y_max = d3.max(nested_data_mult[i].values, function(d) { return +d.capita; });

            y = d3.scale.linear()
              .domain([0, y_max]).nice()
              .range([height, 0]);

            yAxis = d3.svg.axis()
              .scale(y)
              .orient("left")
              .ticks(5)
              .tickPadding(10)
              .innerTickSize(0)
              .tickValues([0, y_max])
              ;

            d3.select("#plot_" + nested_data_mult[i].key.replace(/\s+/g, '')).selectAll(".bar")
              .data(nested_data_mult[i].values)
              .transition()
              .duration(750)
              .attr("x", function(d) { return x(d.age_group); })
              .attr("y", function(d) { return y(+d.capita); })
              .attr("height", function(d) { return height - y(+d.capita);})
              .attr("width", x.rangeBand())
              .style("fill",function(d) {return c(d.gender);})
              .style("opacity", 1);
            
            d3.select("#sm_mult").select("y axis_m")
              .transition()
              .duration(750)
              .call(yAxis);

          }
        }





        function draw_horz_bar(){  

          var margin = {top: 50, right: 50, bottom: 20, left: 250},
              width = 700 - margin.left - margin.right,
              height = 400 - margin.top - margin.bottom;


          var svg_horz = d3.select("#horz_bar")
            .append("svg")
              .attr("id", "horz_bar_plot")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          var data_horz = subset(dataset, filters_horz).sort(function(a, b) {
            return d3.ascending(a.death_cause, b.death_cause); 
          }); 

          var x = d3.scale.linear()
              .domain([0, d3.max(data_horz, function(d) { return +d.capita; })])
              .range([0, width])
              .nice();

          var y = d3.scale.ordinal()
              .domain(data_horz.map(function(d) { return d.death_cause; }))
              .rangeRoundBands([0, height], .1);

          var xAxis = d3.svg.axis()
              .scale(x)
              .ticks(5)
              .orient("top");

          var yAxis = d3.svg.axis()
              .scale(y)
              .orient("left")
              .tickPadding(5)
              .innerTickSize(0)
              .outerTickSize(0);


          svg_horz.selectAll(".bar")
              .data(data_horz)
            .enter().append("g")
              .attr("class", "bar")
              .attr("transform", function(d, i) { return "translate(0," + y(d.death_cause) + ")"; })
            .append("rect")
              .attr("height", y.rangeBand())
              .attr("width", function(d) { return x(+d.capita); })
              .style("fill",function(d) {return c(d.gender);})
              .style("opacity", 1);

          svg_horz.selectAll("text")
            .data(data_horz)
            .enter()
            .append("text")
            .attr("class", "horz_txt_x")
            .attr("x", function(d) { return x(+d.capita); })
            .attr("y", function(d) { return y(d.death_cause) + y.rangeBand() / 2; })
            .attr("dx", 3) // padding-left
            .attr("dy", ".35em") // vertical-align: middle
            .attr("text-anchor", "start") // text-align: right
            .attr("fill", "black")
            .attr("stroke", "none")
            .text(function(d) { return (+d.capita < 0.0001) ? null: rnd_digits(+d.capita); })
            ;

          svg_horz.append("g")
            .attr("class", "y axis_h")
            .call(yAxis);

          svg_horz.append("g")
            .attr("class", "x axis_h")
            //.attr("transform", "translate(0," + height +  ")")
            .call(xAxis);

          svg_horz.append("text")
            .attr("class", "x label")
            .attr("text-anchor", "middle")
            .attr("x", (width / 2))
            .attr("y", (-margin.top /2))
            .text("Per Capita Suicide Rate")
            //.style("font-size", "110%")
            //.style("font-weight", "bold")
            ;


          //d3.select("input#ckbx_sort").on("change", change1);

          function change1() {

            var y0 = y.domain(data_horz.sort(this.checked
                ? function(a, b) { return +b.capita - +a.capita; }
                : function(a, b) { return d3.ascending(a.death_cause, b.death_cause); })
                .map(function(d) { return d.death_cause; }))
                .copy();

            svg_horz.selectAll(".bar").transition()
            .duration(750)
                .delay(function(d, i) { return i * 50; })
                .attr("transform", function(d, i) { return "translate(0," + y0(d.death_cause) + ")"; });

            svg_horz.selectAll("text.horz_x").transition()
            .duration(750)
                .delay(function(d, i) { return i * 50; })
                .attr("y", function(d) { return y(d.death_cause) + (y.rangeBand() / 2); })
                ;

            svg_horz.select(".y.axis_h").transition()
                .duration(750)
                .call(yAxis)
              .selectAll("g")
                .delay(function(d, i) { return i * 50; });
            }
          }

          draw_horz_bar();




        function update_horz(){


          var margin = {top: 50, right: 50, bottom: 20, left: 250},
              width = 700 - margin.left - margin.right,
              height = 400 - margin.top - margin.bottom;

          var data_horz = subset(dataset, filters_horz).sort(function(a, b) {
            return d3.ascending(a.death_cause, b.death_cause); 
          }); 

          var x = d3.scale.linear()
              .domain([0, d3.max(data_horz, function(d) { return +d.capita; })])
              .range([0, width])
              .nice();

          var y = d3.scale.ordinal()
              .domain(data_horz.map(function(d) { return d.death_cause; }))
              .rangeRoundBands([0, height], .1);

          var xAxis = d3.svg.axis()
              .scale(x)
              .ticks(5)
              .orient("top");



          d3.select("#horz_bar_plot").selectAll("rect")
            .data(data_horz)
              .transition()
              .duration(750)
              .attr("height", y.rangeBand())
              .attr("width", function(d) { return x(+d.capita); })
              .style("fill",function(d) {return c(d.gender);})
              .style("opacity", 1);


          d3.selectAll(".horz_txt_x")
            .data(data_horz)
            .transition()
            .duration(750)
            .attr("x", function(d) { return x(+d.capita); })
            .attr("y", function(d) { return y(d.death_cause) + y.rangeBand() / 2; })
            .attr("dx", 3) // padding-left
            .text(function(d) { return (+d.capita < 0.0001) ? null: rnd_digits(+d.capita); })
            ;

          d3.select("#horz_bar").select(".x.axis_h")
            .transition()
            .duration(750)
            .call(xAxis);

        }


      }); //end  d3.csv






      function deepcopy(obj) {
          if (obj === null || typeof obj !== 'object') {
              return obj;
          }
          var temp = obj.constructor(); 
          for (var key in obj) {
              temp[key] = deepcopy(obj[key]);
          }
          return temp;
      }





      function subset(d, filters){
        return d.filter(function(row) {
          return ['year','gender','race','age_group','death_cause'].reduce(function(prev, column) {
              return prev && (
                !filters[column] ||
                    row[column] === filters[column] ||
                    // pass if the row's value is in an array of filter values
                    filters[column].indexOf(row[column]) >= 0
                  );
            }, true); //inital prev value
        })
      }

      Array.prototype.move = function (old_index, new_index) {
          while (old_index < 0) {
              old_index += this.length;
          }
          while (new_index < 0) {
              new_index += this.length;
          }
          if (new_index >= this.length) {
              var k = new_index - this.length;
              while ((k--) + 1) {
                  this.push(undefined);
              }
          }
          this.splice(new_index, 0, this.splice(old_index, 1)[0]);
          //return this; // for testing purposes
      }



    </script>


  </body>
</html>